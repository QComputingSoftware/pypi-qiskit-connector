# @Author: Dr. Jeffrey Chijioke-Uche, IBM Quantum Ambassador
# @last update: 2025-03-01

name: Sync Tag ‚Üí GitHub Release

on:
  push:
    tags:
      - '[v]?[0-9]+.[0-9]+.[0-9]+*'
    branches:
      - main
  workflow_dispatch: 

permissions:
  contents: write
  actions: write
  deployments: write
  pull-requests: write
  checks: write
  statuses: write

env:
  GPG_NAME_REAL: ${{ secrets.GPG_NAME_REAL }}
  GPG_NAME_EMAIL: ${{ secrets.GPG_NAME_EMAIL }}
  GPG_NAME_COMMENT: ${{ secrets.GPG_NAME_COMMENT }}
  GPG_GITHUB_OPERATOR: ${{ secrets.GPG_GITHUB_OPERATOR }}
  EXPECTED_GPG_KEY_ID: ${{ secrets.EXPECTED_GPG_KEY_ID }}
  UNAME_CONTRIBUTOR_09: ${{ secrets.UNAME_CONTRIBUTOR_09 }}
  UNAME_CONTRIBUTOR_03: ${{ secrets.UNAME_CONTRIBUTOR_03 }}
  EMAIL_CONTRIBUTOR_09: ${{ secrets.EMAIL_CONTRIBUTOR_09 }}
  EMAIL_CONTRIBUTOR_03: ${{ secrets.EMAIL_CONTRIBUTOR_03 }}
  
jobs:
  create_release:
    name: üè∑Ô∏è Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Create GitHub Release with fallback for existing tags
        shell: bash
        run: |
          echo "ü™™ Tag detected: ${{ github.ref_name }}"
          echo "‚öôÔ∏è Attempting to create GitHub Release..."

          json=$(
            jq -n --arg tag "${{ github.ref_name }}" --arg body "Auto‚Äêgenerated release for tag ${{ github.ref_name }}" '{
              tag_name: $tag,
              name: "Release \($tag)",
              body: $body,
              draft: false,
              prerelease: ($tag | test("-") )
            }'
          )

          response=$(curl -s -o response.json -w "%{http_code}" \
            -X POST "https://api.github.com/repos/${{ github.repository }}/releases" \
            -H "Authorization: token ${{ secrets.PAT_GITHUB }}" \
            -H "Accept: application/vnd.github+json" \
            -d "$json")

          if [[ "$response" == "201" ]]; then
            echo "‚úÖ Release created successfully."
          elif [[ "$response" == "422" ]]; then
            echo "‚ö†Ô∏è Release already exists. Skipping creation."
          else
            echo "‚ùå Unexpected error occurred:"
            cat response.json
            exit 1
          fi

        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
          GITHUB_REF_NAME: ${{ github.ref_name }}