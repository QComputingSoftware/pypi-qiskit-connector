# @Author: Dr. Jeffrey Chijioke-Uche, IBM Quantum Ambassador
# @last update: 2025-03-01

name: Sync Tag â†’ GitHub Release

on:
  push:
    tags:
      - '[v]?[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch: 
  schedule:
    - cron: '0 10 * * 0'    

permissions:
  contents: write
  actions: write
  deployments: write
  pull-requests: write
  checks: write
  statuses: write
  
jobs:
  create_release:
    name: ğŸ·ï¸ Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checking if latest commit is signed with GPG
        shell: bash
        run: |
          echo "ğŸ” Checking if the latest commit is signed..."
          if git log -1 --pretty=format:'%G?' | grep -q 'G'; then
            echo "âœ… Latest commit is signed."
          else
            echo "âŒ Latest commit is not signed. Exiting"
            exit 1
          fi

      - name: ğŸ§¾ Create GitHub Release with fallback for existing tags
        shell: bash
        run: |
          echo "ğŸªª Tag detected: ${{ github.ref_name }}"
          echo "âš™ï¸ Attempting to create GitHub Release..."

          json=$(
            jq -n --arg tag "${{ github.ref_name }}" --arg body "Autoâ€generated release for tag ${{ github.ref_name }}" '{
              tag_name: $tag,
              name: "Release \($tag)",
              body: $body,
              draft: false,
              prerelease: ($tag | test("-") )
            }'
          )

          response=$(curl -s -o response.json -w "%{http_code}" \
            -X POST "https://api.github.com/repos/${{ github.repository }}/releases" \
            -H "Authorization: token ${{ secrets.PAT_GITHUB }}" \
            -H "Accept: application/vnd.github+json" \
            -d "$json")

          if [[ "$response" == "201" ]]; then
            echo "âœ… Release created successfully."
          elif [[ "$response" == "422" ]]; then
            echo "âš ï¸ Release already exists. Skipping creation."
          else
            echo "âŒ Unexpected error occurred:"
            cat response.json
            exit 1
          fi

        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
          GITHUB_REF_NAME: ${{ github.ref_name }}