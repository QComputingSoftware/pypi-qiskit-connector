# @Author: Dr. Jeffrey Chijioke-Uche
# @Last Modified: 2025-05-10
# @Purpose: Automatically sign all unsigned GitHub release tags/commits using GPG and verified secret identity.
# @Signer: Dr. Jeffrey Chijioke-Uche
#_______________________________________________________________________________________________________________

name: üîê Sign & Verify All Release Tags

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 * * * *' 

permissions:
  contents: write
  actions: write
  deployments: write
  pull-requests: write
  checks: write
  statuses: write
  issues: write
  discussions: write
  pages: write
  packages: write

jobs:
  sign-release-tags:
    runs-on: ubuntu-latest

    env:
      GPG_NAME_REAL: ${{ secrets.GPG_NAME_REAL }}
      GPG_NAME_EMAIL: ${{ secrets.GPG_NAME_EMAIL }}
      GPG_NAME_COMMENT: ${{ secrets.GPG_NAME_COMMENT }}

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install qiskit-connector from PyPI
        run: |
          python -m pip install --upgrade pip
          # if your connector is published on PyPI:
          pip install qiskit-connector

      - name: Qiskit Connector sanity check
        run: |
          python3 - << 'PYCODE'
          # Test if qiskit_connector is installed and importable on any Quantum Algorithm Code.
          try:
              from qiskit_connector import QConnectorV2 as connector
              from qiskit_connector import QPlanV2 as plan

              print("‚úÖ Successfully imported connector and plan")
              print("‚úÖ Qiskit  Connector is Compatible - Plan is available") 
              print("‚úÖ Qiskit Connector is Compatible with these Quantum Algoritms - Connector is available for Qiskit")
          except ImportError as compatibility_error:
              print(f"‚ùå Qiskit Connection is not compatible: {compatibility_error}")
              exit(1)
          PYCODE

      - name: üîê Generate GPG Key Pair
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg

          cat > genkey <<EOF
          Key-Type: RSA
          Key-Length: 4096
          Subkey-Type: RSA
          Subkey-Length: 4096
          Name-Real: $GPG_NAME_REAL
          Name-Email: $GPG_NAME_EMAIL
          Name-Comment: $GPG_NAME_COMMENT
          Expire-Date: 0
          %no-protection
          %commit
          EOF

          gpg --batch --generate-key genkey

          echo "üîç GPG Key generated successfully"
          gpg --list-secret-keys --keyid-format=long

          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format=long | grep '^sec' | awk '{print $2}' | cut -d'/' -f2)
          echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV

      - name: ‚öôÔ∏è Configure Git Identity and Signing
        run: |
          git config --global user.name "$GPG_NAME_REAL"
          git config --global user.email "$GPG_NAME_EMAIL"
          git config --global user.signingkey $GPG_KEY_ID
          git config --global commit.gpgsign true
          git config --global tag.gpgSign true

      - name: üè∑Ô∏è Sign All Unsigned Release Tags
        run: |
          for tag in $(git tag --sort=creatordate); do
            echo "üîç Checking tag: $tag"
            if ! git tag -v "$tag" 2>&1 | grep -q "Good signature"; then
              echo "üîÑ Re-signing tag: $tag"
              commit_sha=$(git rev-list -n 1 "$tag")
              tag_message=$(git for-each-ref --format="%(contents)" refs/tags/$tag)

              git tag -d "$tag"
              GIT_COMMITTER_DATE="$(git show -s --format=%ci "$commit_sha")" \
              GIT_AUTHOR_DATE="$(git show -s --format=%ci "$commit_sha")" \
              git tag -s "$tag" "$commit_sha" -m "$tag_message"

              git push --force origin "$tag"
            else
              echo "‚úÖ Tag $tag already signed. Skipping."
            fi
          done

      - name: üñäÔ∏è Sign All Unsigned Commits
        run: |
          for commit in $(git rev-list --all); do
            if ! git verify-commit $commit &>/dev/null; then
              echo "üîÑ Re-signing commit: $commit"
              GIT_COMMITTER_DATE="$(git show -s --format=%ci $commit)" \
              GIT_AUTHOR_DATE="$(git show -s --format=%ci $commit)" \
              GIT_AUTHOR_NAME="$GPG_NAME_REAL" \
              GIT_AUTHOR_EMAIL="$GPG_NAME_EMAIL" \
              GIT_COMMITTER_NAME="$GPG_NAME_REAL" \
              GIT_COMMITTER_EMAIL="$GPG_NAME_EMAIL" \
              git commit --amend --no-edit --gpg-sign=$GPG_KEY_ID || true
            else
              echo "‚úÖ Commit $commit already signed. Skipping."
            fi
          done
