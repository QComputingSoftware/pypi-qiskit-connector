# @Author: Dr. Jeffrey Chijioke-Uche, IBM Quantum Ambassador
# @last update: 2025-03-01

name: Qiskit Connector Code Coverage Analysis

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

  workflow_dispatch:  # Required for external workflows to trigger this via API

permissions:
  contents: write
  actions: write

jobs:
  coverage-badge:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout main branch only
        uses: actions/checkout@v4
        with:
          ref: refs/heads/main   # ğŸ”’ Avoid tag/branch ambiguity

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip setuptools wheel
          pip install pytest coverage pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install qiskit-connector

      - name: ğŸ§ª Run tests with coverage
        run: coverage run --source=qiskit_connector -m pytest

      - name: ğŸ“Š Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(coverage report | grep "TOTAL" | awk '{print $4}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          echo "coverage=$COVERAGE%" >> "$GITHUB_OUTPUT"

      - name: ğŸ“‚ Ensure badge directory exists
        run: mkdir -p docs/badges

      - name: ğŸ› ï¸ Generate coverage badge
        uses: emibcn/badge-action@v2
        with:
          label: "Qiskit Connector Code Coverage Analysis"
          label-color: "555"
          status: "${{ steps.coverage.outputs.coverage }}"
          color: "green"
          style: "classic"
          path: "docs/badges/coverage.svg"

      - name: ğŸš€ Commit badge to main and sync to stable
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          # ğŸ§¼ Clean workspace
          git reset --hard
          git clean -fd

          # âœ… Ensure weâ€™re truly on main
          git fetch origin refs/heads/main:refs/remotes/origin/main
          git checkout -B main origin/main

          git add docs/badges/coverage.svg
          git commit -m "ğŸ›¡ï¸ Qiskit Code Update - Inteli Check" || echo "âš ï¸ No changes to commit"
          git push -f origin HEAD:refs/heads/main

          # # âœ… Sync to stable
          # git fetch origin refs/heads/stable:refs/remotes/origin/stable || true
          # git checkout -B stable origin/stable || git checkout -b stable
          # if git merge main -m "ğŸ” Sync coverage badge from main to stable"; then
          #   git push -f origin HEAD:refs/heads/stable
          # else
          #   echo "âš ï¸ Merge conflict detected. Skipping push to protect stable."
          #   git merge --abort || true
          # fi
