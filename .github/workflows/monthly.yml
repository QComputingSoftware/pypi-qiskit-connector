# @Author: Dr. Jeffrey Chijioke-Uche, IBM Quantum Ambassador
# @last update: 2025-05-03
# @Description: This workflow scrapes public Pepy.tech stats for the Qiskit Connector package and updates the badge.
# @File: .github/workflows/m-downloads.yml
# @Usage: Triggered on schedule or manually; no API key required now.
#_________________________________________________________________________________________________________

name: 📿 Monthly Downloads

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # Daily at 2 AM UTC
    - cron: "0 2 * * 0"   # Sunday
    - cron: "0 2 * * 1"   # Monday
    - cron: "0 2 * * 2"   # Tuesday
    - cron: "0 2 * * 3"   # Wednesday
    - cron: "0 2 * * 4"   # Thursday
    - cron: "0 2 * * 5"   # Friday
    - cron: "0 2 * * 6"   # Saturday

permissions:
  contents: write
  actions: write

jobs:
  build-monthly-downloads-badge:
    name: 📊 Scrape Monthly Downloads from Pepy
    runs-on: ubuntu-latest

    steps:
      - name: 📿 Checkout
        uses: actions/checkout@v4

      - name: 🔍 Scrape Pepy Public Page for Downloads
        id: get_downloads
        run: |
          echo "🔍 Scraping download data from Pepy.tech public page..."

          pip install beautifulsoup4 lxml

          python3 - << 'PYCODE'
          import urllib.request
          from bs4 import BeautifulSoup
          import re
          import os

          URL = "https://pepy.tech/projects/qiskit-connector?timeRange=threeMonths&includeCIDownloads=true"

          try:
              with urllib.request.urlopen(URL) as response:
                  html = response.read()

              soup = BeautifulSoup(html, "lxml")
              pattern = re.compile(r'"total_downloads"\s*:\s*(\d+)')
              total = None

              for script in soup.find_all("script"):
                  match = pattern.search(script.text)
                  if match:
                      total = int(match.group(1))
                      break

              if total is None:
                  raise ValueError("Could not extract download stats from HTML")

              monthly = round(total * 0.4333)
              print(f"✅ Total (3-mo): {total}, Approx. Monthly: {monthly}")

              with open(os.environ['GITHUB_OUTPUT'], 'a') as output_file:
                  output_file.write(f"monthly_downloads={monthly}\n")

          except Exception as e:
              print(f"❌ Scraping failed: {e}")
              exit(1)
          PYCODE


      - name: 🚰️ Generate Badge
        uses: emibcn/badge-action@v2
        with:
          label: "Monthly Downloads"
          label-color: "555"
          status: "${{ steps.get_downloads.outputs.monthly_downloads }}"
          color: "blue"
          style: "flat"
          path: "doc/badges/monthly-downloads.svg"

      - name: 🚀 Commit and Push Badge
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add doc/badges/monthly-downloads.svg
          git commit -m "📈 Update monthly downloads badge" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
