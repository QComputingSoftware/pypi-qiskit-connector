# @Author: Dr. Jeffrey Chijioke-Uche, IBM Quantum Ambassador
# @last update: 2025-05-03
# @Description: This workflow scrapes public Pepy.tech stats for the Qiskit Connector package and updates the badge.
# @File: .github/workflows/m-downloads.yml
# @Usage: Triggered on schedule or manually; no API key required now.
#_________________________________________________________________________________________________________

name: ğŸ“¿ Monthly Downloads

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # Daily at 2 AM UTC
    - cron: "0 2 * * 0"   # Sunday
    - cron: "0 2 * * 1"   # Monday
    - cron: "0 2 * * 2"   # Tuesday
    - cron: "0 2 * * 3"   # Wednesday
    - cron: "0 2 * * 4"   # Thursday
    - cron: "0 2 * * 5"   # Friday
    - cron: "0 2 * * 6"   # Saturday

permissions:
  contents: write
  actions: write

jobs:
  build-monthly-downloads-badge:
    name: ğŸ“Š Monthly Downloads from Pepy
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¿ Checkout
        uses: actions/checkout@v4


      - name: Install qiskit-connector & markdown
        run: |
          python -m pip install --upgrade pip
          pip install qiskit-connector
          pip install markdown
          pip install beautifulsoup4 lxml
          pip install requests

      - name: ğŸ” Pepy Public Page for Downloads
        id: get_downloads
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          URL: ${{ secrets.URL }}
        run: |
          echo "ğŸ” Getting download data from Pepy.tech public page..."
          python3 - << 'PYCODE'
          import urllib.request
          from bs4 import BeautifulSoup
          import re
          import os
          import markdown
          import sys
          import logging
          import requests
          from urllib.parse import urlparse
          import json

            URL = os.environ.get("URL")
            
            try:
              if URL:
                # Check if the URL is valid
                if not URL.startswith("http"):
                  raise ValueError("Invalid URL")
                else:
                  import markdown
                  markdown_text = """[![PyPI Downloads](https://static.pepy.tech/badge/qiskit-connector)](https://pepy.tech/projects/qiskit-connector)"""
                  html_output = markdown.markdown(markdown_text)
                  print(html_output)
              
              # Extract the numeric value from the HTML output
              match = re.search(r'\d+', html_output)
              if match:
                numeric_value = match.group(0)
                print(f"Extracted Numeric Value: {numeric_value}")
              else:
                raise ValueError("No numeric value found in the HTML output")
            
          except Exception as e:
              print(f"âŒ Scraping failed: {e}")
              exit(1)
          PYCODE

          exit 0

      - name: ğŸš°ï¸ Generate Badge
        uses: emibcn/badge-action@v2
        with:
          label: "Monthly Downloads"
          label-color: "555"
          status: "${{ steps.get_downloads.outputs.monthly_downloads }}"
          color: "blue"
          style: "flat"
          path: "doc/badges/monthly-downloads.svg"

      - name: ğŸš€ Commit and Push Badge
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add doc/badges/monthly-downloads.svg
          git commit -m "ğŸ“ˆ Update monthly downloads badge" || echo "No changes to commit"
          git push

