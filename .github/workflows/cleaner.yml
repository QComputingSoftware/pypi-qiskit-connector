name: üßπ Delete Failed & Cancelled Workflow Runs
# This workflow deletes failed and cancelled workflow runs to keep the Actions tab clean.
# It uses the GitHub CLI to authenticate and delete the runs.
# The workflow is triggered on push to the main and stable branches, and on a daily schedule.
# It requires a Personal Access Token (PAT) with repo and workflow permissions, stored in the repository secrets as PAT_GITHUB.
# The workflow runs on the latest Ubuntu environment.
# The workflow is set to run daily at 6:00 AM EST.
# The workflow is named "Delete Failed & Cancelled Workflow Runs" and is triggered on push to the main and stable branches, as well as on a daily schedule.
# The workflow uses the GitHub CLI to authenticate and delete the runs.


on:
  push:
    branches: [ "main", "stable" ]

  schedule:
    - cron: '0 10 * * *'  # 6:00 AM EST daily

permissions:
  actions: write
  contents: write

jobs:
  cleanup-failed-and-cancelled:
    name: üö´ Clean Up Failed & Cancelled Runs
    runs-on: ubuntu-latest

    steps:
      - name: üõ†Ô∏è Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: üîê Authenticate GitHub CLI with PAT
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          echo "${GH_TOKEN}" | gh auth login --with-token
          gh auth status

      - name: üßº Delete failed and cancelled workflow runs
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          echo "üîç Finding workflow runs with status failure or cancelled..."
          runs=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs \
            --paginate \
            -q '.workflow_runs[] | select(.conclusion=="failure" or .conclusion=="cancelled") | .id')

          if [ -z "$runs" ]; then
            echo "‚úÖ No failed or cancelled runs to delete."
          else
            for run_id in $runs; do
              echo "üóëÔ∏è Deleting workflow run ID: $run_id"
              gh api -X DELETE \
                -H "Accept: application/vnd.github+json" \
                /repos/${{ github.repository }}/actions/runs/$run_id
            done
            echo "‚úÖ Cleanup complete."
          fi
