name: 🧹 Delete Failed & Cancelled Workflow Runs

on:
  push:
    branches: [ "main", "stable" ]

  schedule:
    - cron: '0 10 * * *'  # 6:00 AM EST daily

permissions:
  actions: write
  contents: write

jobs:
  cleanup-failed-and-cancelled:
    name: 🚫 Clean Up Failed & Cancelled Runs
    runs-on: ubuntu-latest

    steps:
      - name: 🛠️ Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: 🔐 Authenticate GitHub CLI with PAT
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          echo "${GH_TOKEN}" | gh auth login --with-token
          gh auth status

      - name: 🧼 Delete failed and cancelled workflow runs
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        run: |
          echo "🔍 Finding workflow runs with status failure or cancelled..."
          runs=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs \
            --paginate \
            -q '.workflow_runs[] | select(.conclusion=="failure" or .conclusion=="cancelled") | .id')

          if [ -z "$runs" ]; then
            echo "✅ No failed or cancelled runs to delete."
          else
            for run_id in $runs; do
              echo "🗑️ Deleting workflow run ID: $run_id"
              gh api -X DELETE \
                -H "Accept: application/vnd.github+json" \
                /repos/${{ github.repository }}/actions/runs/$run_id
            done
            echo "✅ Cleanup complete."
          fi
