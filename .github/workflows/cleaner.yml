name: Delete Failed & Cancelled Workflow Runs

on:
  push:
    branches: [ "main", "stable" ]

  schedule:
    - cron: '0 10 * * *'  # 6:00 AM EST daily

permissions:
  actions: write
  contents: write
  checks: write
  deployments: write
  pages: write
  pull-requests: write
  statuses: write
  repository-projects: write
  security-events: write
  attestations: write
  metadata: write
  packages: write

jobs:
  cleanup-failed-and-cancelled:
    name: üö´ Clean Up Failed & Cancelled Runs
    runs-on: ubuntu-latest

    steps:
      - name: üõ†Ô∏è Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: üßº Delete failed and cancelled workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Finding failed or cancelled runs..."
          runs=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs \
            --paginate \
            -q '.workflow_runs[] | select(.conclusion=="failure" or .conclusion=="cancelled") | .id')

          if [ -z "$runs" ]; then
            echo "‚úÖ No failed or cancelled runs found."
          else
            for run_id in $runs; do
              echo "üóëÔ∏è Attempting to delete run ID: $run_id"
              response=$(gh api -X DELETE \
                -H "Accept: application/vnd.github+json" \
                /repos/${{ github.repository }}/actions/runs/$run_id 2>&1)
              
              if echo "$response" | grep -q "404"; then
                echo "‚ö†Ô∏è Skipping run ID $run_id - Not found or unauthorized."
              else
                echo "‚úÖ Successfully deleted run ID $run_id"
              fi
            done
            echo "‚úÖ Cleanup attempt complete."
          fi

